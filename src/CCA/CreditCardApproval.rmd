---
title: "Credit Card Approval Prediction Model"
author: "Marcelo Capozzi - Nicolas Gladkoff"
date: "Abril 2020"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

### DataSource:
https://www.kaggle.com/rikdifos/credit-card-approval-prediction

### GitHub:
https://github.com/ngladkoff/ds-credit-card-approval


```{r, message=FALSE}
##################
# Load libraries #
##################
library(ggplot2)
library(dplyr)
library(sqldf)

```

```{r}
######################
# Download datafiles #
######################

# Set the data directory 
# It will be a subdirectory 'data/' of the current directory
maindir <- getwd()
datadir <- paste(maindir, "data", sep="/")

applRecordURL <- "https://raw.githubusercontent.com/ngladkoff/ds-credit-card-approval/master/data/application_record.csv"
credRecordURL <- "https://raw.githubusercontent.com/ngladkoff/ds-credit-card-approval/master/data/credit_record.csv"

applRecordFile <- paste(datadir, "applRecord.csv", sep="/")
credRecordFile <- paste(datadir, "credRecord.csv", sep="/")

if (!dir.exists(datadir)) {
    print(paste("Creating data directory ", datadir))
    dir.create(datadir)
}

if (!file.exists(applRecordFile)) {
    print("Downloading Application Records")
    download.file(applRecordURL, applRecordFile, method="auto")
} else {
    print(paste("Data file", applRecordFile, "already exists"))
}

if (!file.exists(credRecordFile)) {
    print("Downloading Application Records")
    download.file(credRecordURL, credRecordFile, method="auto")
} else {
    print(paste("Data file", credRecordFile, "already exists"))
}

```

```{r}
#######################
# Load the dataframes #
#######################

dfApplications <- read.csv(applRecordFile)
dfCredit <- read.csv(credRecordFile)

```


## Applications Records Structure
```{r}
str(dfApplications)
```


## Credit Records Structure
```{r}
str(dfCredit)
```

Se observan IDs repetidos

## Head de Credit Records
```{r}
head(dfCredit)
```

## Open Data Viewer
```{r}
View(dfCredit)
```

## Evaluo IDs duplicados en Applications
```{r}
dfAppIds <- data.frame(table(dfApplications$ID))
str(dfAppIds)
summary(dfAppIds)

```

## Evaluo IDs duplicados en Credits
```{r}
dfCredIds <- data.frame(table(dfCredit$ID))
str(dfCredIds)
summary(dfCredIds)

```

## Analisis de duplicados
```{r}
cUniAppIds <- dim(dfApplications[unique(dfApplications$ID),])[1]
cDupAppIds <- dim(dfApplications[duplicated(dfApplications$ID),])[1]
cDupAppRecord <- dim(dfApplications[duplicated(dfApplications),])[1]
dfDupAppIds <- dfApplications[duplicated(dfApplications$ID),]
cAppIds <- dim(dfApplications)[1]

print(paste("IDs unicos:", cUniAppIds))
print(paste("IDs duplicados:", cDupAppIds))
print(paste("Records duplicados: ", cDupAppRecord))
print(paste("Total:", cAppIds))
print(paste("Duplicados: %", (round((cDupAppIds*100/cAppIds), digits=2))))

```

## Hicimos una limpieza del 1er dataset
```{r}
dfDupAppIds2 <- data.frame(dfDupAppIds$ID)
dfDupIds <- sqldf("SELECT distinct ID FROM dfApplications WHERE ID in dfDupAppIds2")
print(dfDupIds)

dfAppCleaned <- sqldf("SELECT * FROM dfApplications WHERE ID NOT in dfDupAppIds2")
cNewTotal <- dim(dfAppCleaned)[1]
print(cAppIds - cNewTotal)
```

## Obtener predictor desde Creditos

```{r}

dfCredIdMonth <- sqldf("SELECT ID, MAX(MONTHS_BALANCE) as LAST FROM dfCredit GROUP BY ID order by LAST")
summary(dfCredIdMonth)

```

```{r}
dfCreditCleaned <- sqldf("SELECT t1.ID, t1.LAST, t2.STATUS FROM dfCredIdMonth t1 JOIN dfCredit t2 ON t1.ID = t2.ID and t1.LAST = t2.MONTHS_BALANCE")
summary(dfCreditCleaned)
```

```{r}
dfCreditCleaned$STATUS <- ifelse(dfCreditCleaned$STATUS == 'C' | dfCreditCleaned$STATUS == 'X', 1, 0)
dfCreditCleaned$STATUS <- factor(dfCreditCleaned$STATUS, ordered=FALSE)
summary(dfCreditCleaned)
```


## Applications Records Summary
```{r}
summary(dfApplications)
```


## Credit Records Summary
```{r}
summary(dfCredit)
```

## Merge Data (antes de mergear la data hay que limpiarla! o hacer un pivot de los meses? los meses llegan hasta -60 -> sacar conclusiones y ajustar a una columna? -> ejemplo: antig√∫edad del prestamo o credit record)
```{r}
dfCreditCard <- merge(dfApplications, dfCredit, by="ID")
```

## Merge Structure
```{r}
str(dfCreditCard)
```


## Merge Summary
```{r}
summary(dfCreditCard)
```

